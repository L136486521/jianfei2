name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    # 允许手动触发构建
    inputs:
      debug_mode:
        description: 'Enable debug mode for detailed logs'
        required: false
        default: 'true'
        type: boolean

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'  # 缓存pip依赖
        cache-dependency-path: 'requirements.txt'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential git zip unzip openjdk-17-jdk zlib1g-dev libxslt1-dev libxml2-dev expect
        echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV

    # 缓存Android SDK以加速构建
    - name: Cache Android SDK
      uses: actions/cache@v3
      with:
        path: |
          ~/android-sdk
          ~/.buildozer
        key: ${{ runner.os }}-android-sdk-cache
        restore-keys: |
          ${{ runner.os }}-android-sdk-
    
    - name: Set up Android SDK
      run: |
        # 下载和配置SDK
        SDK_DIR="$HOME/android-sdk"
        mkdir -p "$SDK_DIR"
        
        # 下载SDK工具包
        SDK_URL="https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip"
        wget -q "$SDK_URL" -O "$SDK_DIR/sdk-tools.zip"
        
        # 解压SDK工具包
        unzip -q "$SDK_DIR/sdk-tools.zip" -d "$SDK_DIR"
        
        # 设置目录结构
        mkdir -p "$SDK_DIR/cmdline-tools/latest"
        mv "$SDK_DIR/cmdline-tools/bin" "$SDK_DIR/cmdline-tools/lib" "$SDK_DIR/cmdline-tools/licenses" "$SDK_DIR/cmdline-tools/NOTICE.txt" "$SDK_DIR/cmdline-tools/source.properties" "$SDK_DIR/cmdline-tools/latest/" 2>/dev/null || true
        
        # 创建必要的目录
        mkdir -p "$SDK_DIR/platform-tools" "$SDK_DIR/build-tools" "$SDK_DIR/platforms" "$SDK_DIR/ndk"
        
        # 设置环境变量
        echo "ANDROID_HOME=$SDK_DIR" >> $GITHUB_ENV
        echo "PATH=$SDK_DIR/cmdline-tools/latest/bin:$SDK_DIR/platform-tools:$PATH" >> $GITHUB_ENV

    - name: Accept Android licenses
      run: |
        # 简单的许可证接受方式
        echo "Accepting Android licenses..."
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

    - name: Install required SDK components
      run: |
        # 安装必要的SDK组件
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --update
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;31.0.0" "platform-tools" "platforms;android-31" "ndk;21.4.7075529"
        
        # 创建Buildozer期望的tools目录结构
        mkdir -p "$ANDROID_HOME/tools/bin"
        ln -sf "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" "$ANDROID_HOME/tools/bin/sdkmanager"
        
        # 确保buildozer能找到SDK组件 - 创建必要的目录结构
        mkdir -p ~/.buildozer/android/platform
        # 创建从实际SDK目录到buildozer期望位置的符号链接
        ln -sf "$ANDROID_HOME" ~/.buildozer/android/platform/android-sdk
        
        # 验证aidl工具是否存在
        echo "Verifying aidl tool installation..."
        find "$ANDROID_HOME/build-tools/31.0.0" -name "aidl" || echo "Warning: aidl not found, but continuing..."

    - name: Install Buildozer
      run: |
        pip install --upgrade pip
        pip install buildozer==1.5.0 cython==0.29.33

    - name: Configure Buildozer
      run: |
        # 在GitHub Actions环境中覆盖冲突的NDK相关环境变量
        # 使用空值覆盖所有可能冲突的NDK路径变量
        echo "ANDROID_NDK=" >> $GITHUB_ENV
        echo "ANDROIDNDK=" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=" >> $GITHUB_ENV
        echo "ANDROID_NDK_LATEST_HOME=" >> $GITHUB_ENV
        
        # 只设置我们需要的环境变量，确保覆盖任何现有值
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/21.4.7075529" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        
        # 创建必要的配置文件，明确设置NDK和SDK路径
        echo "sdk.dir=$ANDROID_HOME" > local.properties
        echo "ndk.dir=$ANDROID_HOME/ndk/21.4.7075529" >> local.properties
        
        # 验证环境变量设置
        echo "Using NDK at: $ANDROID_HOME/ndk/21.4.7075529"
        echo "Using SDK at: $ANDROID_HOME"

    - name: Build APK
      run: |
        # 确保在构建步骤中也使用正确的环境变量
        export ANDROID_NDK_HOME=$ANDROID_HOME/ndk/21.4.7075529
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export GRADLE_OPTS="-Xmx2g"
        
        # 设置构建日志级别，以便更好地调试
        export BUILDOZER_BUILD_LOG_LEVEL=2
        
        # 执行构建命令
        buildozer -v android debug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: weight-tracker-apk
        path: bin/*.apk
        retention-days: 7
